<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Authentification{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav>
        <ul>
            <li><a href="{{ url_for('auth.login') }}">Connexion</a></li>
            <li><a href="{{ url_for('auth.register') }}">Inscription</a></li>
            <li><a href="{{ url_for('profile.profile') }}">Profil</a></li>
            <li><a href="{{ url_for('profile.history') }}">Historique</a></li>
        </ul>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <p style="color: {% if category == 'success' %}green{% else %}red{% endif %};">{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script>
      console.log("Script chargé !");
      const firebaseConfig = {
        apiKey: "AIzaSyBnRxijV8z7vWBqfU2v9_Bx2QAirJxnP8o",
        authDomain: "imcalcultor.firebaseapp.com",
        projectId: "imcalcultor",
        storageBucket: "imcalcultor.firebasestorage.app",
        messagingSenderId: "215614482313",
        appId: "1:215614482313:web:80c7dcc267d24993472358",
        measurementId: "G-YCRYBZSHK5"
      };
      firebase.initializeApp(firebaseConfig);
      console.log("Script chargé 2!");
      document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.querySelector('[name="email"]').value;
        const password = document.querySelector('[name="password"]').value;
        console.log("Email:", email);
        try {
          console.log("test");
          const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
          console.log("Utilisateur connecté :", userCredential.user);
          const idToken = await userCredential.user.getIdToken();
          console.log("Token d'identification :", idToken);
          console.log("ID Token:", idToken);
          // Crée un formulaire caché pour envoyer le token au backend
          const form = document.createElement('form');
          console.log("Formulaire créé !");
          form.method = 'POST';
          form.action = '/login';
          form.innerHTML = `<input type="hidden" name="idToken" value="${idToken}">`;
          console.log("Formulaire créé 2 !");
          document.body.appendChild(form);
          console.log("Formulaire créé 3 !");
          form.submit();
          console.log("Formulaire soumis !");
        } catch (error) {
          console.error('Erreur de connexion JS :', error);
          alert('Erreur de connexion : ' + error.message);
        }
      });
    </script>
</body>
</html>
